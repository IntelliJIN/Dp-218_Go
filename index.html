<!DOCTYPE html>
<html>
    <head>
        <title>API карт 2ГИС</title>
        <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>
        <script type="text/javascript">
            var map;

            let eventSource = new EventSource("/scooter");
            let scooters = new Map();
            // let scooter;

            DG.then(function () {
                map = DG.map('map', {
                    center: [50.0, 40.0],
                    zoom: 50
                });

                // scooter = DG.marker([50.0, 40.0]);
                // scooter.addTo(map);
                // console.log(scooter)
            });

                // scooter = DG.marker([50.0, 40.0]);
                // scooter.addTo(map);



            eventSource.onopen = function(e) {
                console.log("connection: open");
            };

            eventSource.onerror = function(e) {
                console.log("connection: error");
                if (this.readyState == EventSource.CONNECTING) {
                    console.log(`reconnectin=${this.readyState})...`);
                } else {
                    console.log("error occured");
                }
            };

            eventSource.onmessage = function(e) {
                // console.log("message: " + e.data);
                json = JSON.parse(e.data);
                // console.log(json);

                console.log(scooters.has(json.id));

                if (scooters.has(json.id) != true) {
                    console.log("in if");
                    let scr = DG.marker([json.x, json.y]);
                    scr.addTo(map);
                    scooters.set(json.id, scr);
                    // console.log(map);
                    // return;
                }
                let scr = scooters.get(json.id);
                // console.log(scr);
                scr.setLatLng({lat: json.x, lng: json.y});
                console.log(scr.getLatLng());
            };

        </script>
    </head>
    <body>
        <div id="map" style="width:500px; height:400px"></div>
    </body>
</html>
